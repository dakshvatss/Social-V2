<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Profiles Intel</title>
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.4/dist/ag-grid-community.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;0,800;1,400&family=JetBrains+Mono:wght@400;500&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #080d1a;
    --surface:   #0e1525;
    --surface2:  #151f35;
    --surface3:  #1c2a45;
    --border:    #1e2e4a;
    --border2:   #243450;
    --accent:    #f0a500;
    --accent2:   #3d8ef0;
    --accent3:   #8b5cf6;
    --success:   #10b981;
    --danger:    #ef4444;
    --warning:   #f59e0b;
    --text:      #e2eaf8;
    --text2:     #8fa3c4;
    --text3:     #4d6584;
    --fb:        #1877F2;
    --tw:        #1DA1F2;
    --ig:        #E1306C;
    --mono:      'JetBrains Mono', monospace;
    --sans:      'Barlow', sans-serif;
    --cond:      'Barlow Condensed', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€â”€ Header â”€â”€â”€ */
  .app-header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: 52px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
    z-index: 10;
  }
  .logo {
    font-family: var(--cond);
    font-weight: 800;
    font-size: 22px;
    letter-spacing: 1px;
    color: var(--accent);
    text-transform: uppercase;
    white-space: nowrap;
  }
  .logo span { color: var(--text2); font-weight: 400; font-size: 14px; letter-spacing: 0; }
  .header-divider { width: 1px; height: 28px; background: var(--border2); }
  .stat-pill {
    display: flex; align-items: center; gap: 6px;
    padding: 4px 10px;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 20px;
    font-family: var(--mono);
    font-size: 11px;
    white-space: nowrap;
  }
  .stat-pill .num { color: var(--accent); font-weight: 500; }
  .header-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }

  /* â”€â”€â”€ Buttons â”€â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer;
    font-family: var(--sans); font-size: 12px; font-weight: 600;
    letter-spacing: 0.3px; transition: all 0.15s; white-space: nowrap;
  }
  .btn-primary  { background: var(--accent); color: #000; }
  .btn-primary:hover  { background: #ffb822; }
  .btn-ghost    { background: transparent; color: var(--text2); border: 1px solid var(--border2); }
  .btn-ghost:hover { background: var(--surface3); color: var(--text); }
  .btn-danger   { background: var(--danger); color: #fff; }
  .btn-danger:hover  { background: #dc2626; }
  .btn-success  { background: var(--success); color: #fff; }
  .btn-success:hover { background: #059669; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; }

  /* â”€â”€â”€ Layout â”€â”€â”€ */
  .app-body { flex: 1; display: flex; overflow: hidden; }

  /* â”€â”€â”€ Sidebar â”€â”€â”€ */
  .sidebar {
    width: 240px; min-width: 240px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    overflow-y: auto; flex-shrink: 0;
  }
  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  .sidebar-section { padding: 14px 14px 0; }
  .sidebar-label {
    font-family: var(--cond);
    font-size: 10px; font-weight: 700;
    letter-spacing: 1.5px; text-transform: uppercase;
    color: var(--text3);
    padding: 0 0 6px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 10px;
  }

  .filter-group { margin-bottom: 10px; }
  .filter-group label {
    display: block; font-size: 11px; color: var(--text2);
    margin-bottom: 4px; font-weight: 500;
  }
  .filter-group input,
  .filter-group select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 6px;
    color: var(--text);
    padding: 6px 10px;
    font-family: var(--sans); font-size: 12px;
    outline: none; transition: border-color 0.15s;
  }
  .filter-group input:focus,
  .filter-group select:focus { border-color: var(--accent); }
  .filter-group select option { background: var(--surface2); }

  .toggle-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 0; font-size: 12px; color: var(--text2); cursor: pointer;
  }
  .toggle-row:hover { color: var(--text); }
  .toggle {
    width: 32px; height: 18px;
    background: var(--border2); border-radius: 9px;
    position: relative; cursor: pointer; transition: background 0.2s;
    flex-shrink: 0;
  }
  .toggle.on { background: var(--accent); }
  .toggle::after {
    content: ''; position: absolute;
    width: 12px; height: 12px; background: #fff;
    border-radius: 50%; top: 3px; left: 3px;
    transition: transform 0.2s;
  }
  .toggle.on::after { transform: translateX(14px); }

  .btn-reset-filters {
    width: 100%; margin: 10px 0;
    padding: 7px; background: transparent;
    border: 1px dashed var(--border2); border-radius: 6px;
    color: var(--text3); cursor: pointer; font-size: 11px;
    font-family: var(--sans); transition: all 0.15s;
  }
  .btn-reset-filters:hover { border-color: var(--danger); color: var(--danger); }

  /* Platform stats mini */
  .platform-stats { padding: 0 14px 14px; }
  .platform-row {
    display: flex; align-items: center; gap: 8px;
    padding: 7px 0; border-bottom: 1px solid var(--border);
  }
  .platform-row:last-child { border-bottom: none; }
  .platform-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .platform-name { font-size: 11px; color: var(--text2); flex: 1; font-weight: 600; }
  .platform-num  { font-family: var(--mono); font-size: 11px; color: var(--text); }
  .platform-sub  { font-size: 10px; color: var(--text3); }

  /* â”€â”€â”€ Main content â”€â”€â”€ */
  .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  /* â”€â”€â”€ Toolbar â”€â”€â”€ */
  .grid-toolbar {
    padding: 8px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
    flex-shrink: 0; flex-wrap: wrap; min-height: 46px;
  }
  .result-count { font-family: var(--mono); font-size: 11px; color: var(--text3); }

  /* â”€â”€â”€ Cursor Pagination Controls â”€â”€â”€ */
  .pagination-controls {
    display: flex; align-items: center; gap: 6px; margin-left: auto;
  }
  .page-btn {
    display: inline-flex; align-items: center; justify-content: center;
    width: 30px; height: 28px; border-radius: 6px;
    border: 1px solid var(--border2); background: var(--surface2);
    color: var(--text2); cursor: pointer; font-size: 13px; font-weight: 700;
    transition: all 0.15s; flex-shrink: 0;
  }
  .page-btn:hover:not(:disabled) {
    background: var(--surface3); color: var(--text); border-color: var(--accent);
  }
  .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .page-info {
    font-family: var(--mono); font-size: 11px; color: var(--text2);
    padding: 0 6px; white-space: nowrap;
  }
  .page-info strong { color: var(--accent); }
  .page-size-select {
    background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 6px; color: var(--text2);
    padding: 4px 6px; font-family: var(--mono); font-size: 11px;
    outline: none; cursor: pointer; transition: border-color 0.15s;
  }
  .page-size-select:focus { border-color: var(--accent); }
  .page-size-select option { background: var(--surface2); }
  .toolbar-left { display: flex; align-items: center; gap: 8px; }

  /* Loading bar */
  .grid-loading-bar {
    height: 2px; background: var(--border);
    flex-shrink: 0; position: relative; overflow: hidden;
  }
  .grid-loading-bar::after {
    content: ''; position: absolute;
    height: 100%; width: 30%; background: var(--accent);
    animation: loadSlide 1s ease-in-out infinite;
    opacity: 0; transition: opacity 0.2s;
  }
  .grid-loading-bar.loading::after { opacity: 1; }
  @keyframes loadSlide {
    0%   { left: -30%; }
    100% { left: 110%; }
  }

  .grid-wrap { flex: 1; overflow: hidden; }

  /* â”€â”€â”€ AG Grid Theme â”€â”€â”€ */
  .ag-theme-social {
    --ag-background-color: var(--bg);
    --ag-foreground-color: var(--text);
    --ag-header-background-color: var(--surface2);
    --ag-header-foreground-color: var(--text2);
    --ag-odd-row-background-color: #090e1c;
    --ag-row-hover-color: #121e36;
    --ag-selected-row-background-color: #162040;
    --ag-range-selection-background-color: rgba(240,165,0,0.07);
    --ag-border-color: var(--border);
    --ag-secondary-border-color: var(--border);
    --ag-cell-horizontal-border: solid var(--border);
    --ag-font-size: 12px;
    --ag-font-family: 'Barlow', sans-serif;
    --ag-grid-size: 4px;
    --ag-row-height: 36px;
    --ag-header-height: 36px;
    --ag-column-hover-color: #0f1828;
    --ag-input-focus-border-color: var(--accent);
    --ag-checkbox-checked-color: var(--accent);
    --ag-checkbox-unchecked-color: var(--border2);
    --ag-value-change-value-highlight-background-color: rgba(240,165,0,0.2);
    --ag-header-column-separator-color: var(--border2);
    --ag-header-column-separator-height: 60%;
  }
  .ag-theme-social .ag-header-cell-text {
    font-family: var(--cond);
    font-size: 11px; font-weight: 600;
    letter-spacing: 0.5px; text-transform: uppercase; color: var(--text2);
  }
  .ag-theme-social .ag-cell {
    font-family: var(--mono); font-size: 11px;
    border-right: 1px solid var(--border) !important;
    display: flex; align-items: center;
  }
  .ag-theme-social .ag-paging-panel { display: none !important; }

  /* â”€â”€â”€ Cell renderers â”€â”€â”€ */
  .badge {
    display: inline-block; padding: 1px 7px; border-radius: 3px;
    font-size: 10px; font-weight: 700; letter-spacing: 0.5px;
    text-transform: uppercase; font-family: var(--cond);
  }
  /* FIX 1: badges now check boolean true/false/null */
  .badge-active    { background: rgba(16,185,129,0.15); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
  .badge-inactive  { background: rgba(100,116,139,0.12); color: #64748b; border: 1px solid rgba(100,116,139,0.2); }
  .badge-verified  { background: rgba(61,142,240,0.15); color: #60a5fa; border: 1px solid rgba(61,142,240,0.3); }
  .badge-unverified { background: rgba(100,116,139,0.1); color: #475569; border: 1px solid rgba(100,116,139,0.15); }
  .badge-unknown   { background: transparent; color: var(--text3); }

  .num-cell { text-align: right; color: var(--text); font-family: var(--mono); font-size: 11px; }
  .num-hi { color: var(--accent); }

  .action-cell { display: flex; gap: 4px; align-items: center; }
  .act-btn {
    padding: 3px 8px; border-radius: 4px; border: none; cursor: pointer;
    font-size: 10px; font-family: var(--sans); font-weight: 600; transition: all 0.1s;
  }
  .act-edit  { background: rgba(61,142,240,0.15); color: var(--accent2); }
  .act-edit:hover { background: rgba(61,142,240,0.3); }
  .act-del   { background: rgba(239,68,68,0.12); color: var(--danger); }
  .act-del:hover  { background: rgba(239,68,68,0.25); }

  /* â”€â”€â”€ Modal â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface); border: 1px solid var(--border2); border-radius: 12px;
    width: min(700px, 95vw); max-height: 90vh;
    display: flex; flex-direction: column;
    transform: scale(0.96); transition: transform 0.2s;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  .modal-overlay.open .modal { transform: scale(1); }
  .modal-header {
    padding: 18px 22px 16px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
  }
  .modal-title { font-family: var(--cond); font-weight: 700; font-size: 18px; letter-spacing: 0.5px; flex: 1; }
  .modal-close {
    width: 28px; height: 28px; border-radius: 6px;
    background: transparent; border: 1px solid var(--border2);
    color: var(--text2); cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center; transition: all 0.15s;
  }
  .modal-close:hover { background: var(--danger); border-color: var(--danger); color: #fff; }
  .modal-tabs {
    display: flex; padding: 0 22px;
    border-bottom: 1px solid var(--border); background: var(--surface2);
  }
  .modal-tab {
    padding: 10px 16px; font-family: var(--cond);
    font-size: 12px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
    color: var(--text3); cursor: pointer; border: none;
    background: transparent; border-bottom: 2px solid transparent;
    margin-bottom: -1px; transition: all 0.15s;
  }
  .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .modal-tab:hover  { color: var(--text); }
  .modal-body { flex: 1; overflow-y: auto; padding: 20px 22px; }
  .modal-body::-webkit-scrollbar { width: 4px; }
  .modal-body::-webkit-scrollbar-thumb { background: var(--border2); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-grid .span2 { grid-column: span 2; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group label {
    font-size: 11px; color: var(--text2); font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    background: var(--surface2); border: 1px solid var(--border2); border-radius: 6px;
    color: var(--text); padding: 8px 12px;
    font-family: var(--sans); font-size: 13px; outline: none; transition: border-color 0.15s;
  }
  /* FIX 3: date picker colour fix for dark theme */
  .form-group input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); cursor: pointer; }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus { border-color: var(--accent); }
  .form-group select option { background: var(--surface2); }
  .form-group textarea { resize: vertical; min-height: 72px; }
  .platform-header {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 16px; padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  .platform-icon {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; font-size: 14px;
  }
  .platform-icon.fb  { background: rgba(24,119,242,0.15); color: var(--fb); }
  .platform-icon.tw  { background: rgba(29,161,242,0.15); color: var(--tw); }
  .platform-icon.ig  { background: rgba(225,48,108,0.15); color: var(--ig); }
  .platform-label { font-family: var(--cond); font-weight: 700; font-size: 16px; letter-spacing: 0.5px; }
  .modal-footer {
    padding: 14px 22px; border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px; justify-content: flex-end;
    background: var(--surface2); border-radius: 0 0 12px 12px;
  }

  /* â”€â”€â”€ Confirm dialog â”€â”€â”€ */
  .confirm-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    display: flex; align-items: center; justify-content: center;
    z-index: 1100; opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .confirm-overlay.open { opacity: 1; pointer-events: all; }
  .confirm-box {
    background: var(--surface); border: 1px solid var(--border2); border-radius: 10px;
    padding: 28px 30px; width: min(400px, 92vw); text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  .confirm-icon { font-size: 32px; margin-bottom: 12px; }
  .confirm-title { font-family: var(--cond); font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .confirm-msg { color: var(--text2); font-size: 13px; margin-bottom: 22px; line-height: 1.5; }
  .confirm-actions { display: flex; gap: 10px; justify-content: center; }

  /* â”€â”€â”€ Toast â”€â”€â”€ */
  #toast-container {
    position: fixed; bottom: 20px; right: 20px; z-index: 2000;
    display: flex; flex-direction: column; gap: 8px;
  }
  .toast {
    background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px;
    padding: 10px 16px; min-width: 200px; max-width: 320px;
    display: flex; align-items: center; gap: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: slideUp 0.25s ease;
  }
  .toast.success { border-left: 3px solid var(--success); }
  .toast.error   { border-left: 3px solid var(--danger); }
  .toast.info    { border-left: 3px solid var(--accent2); }
  .toast-icon { font-size: 15px; }
  .toast-msg  { font-size: 12px; color: var(--text); flex: 1; }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="app-header">
  <div class="logo">Intel<span> / Social Profiles</span></div>
  <div class="header-divider"></div>
  <div class="stat-pill">Total <span class="num" id="hdr-total">â€”</span></div>
  <div class="stat-pill">ğŸŸ¢ Active <span class="num" id="hdr-active">â€”</span></div>
  <div class="stat-pill">âœ“ Verified <span class="num" id="hdr-verified">â€”</span></div>
  <div class="header-actions">
    <a href="/analytics" class="btn btn-ghost btn-sm">ğŸ“Š Analytics</a>
    <button class="btn btn-ghost btn-sm" id="btn-export">â¬‡ Export CSV</button>
    <button class="btn btn-primary btn-sm" id="btn-add">ï¼‹ Add Profile</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BODY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-body">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Search</div>
      <div class="filter-group">
        <input type="text" id="f-search" placeholder="Name, ID, emailâ€¦" autocomplete="off">
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Filters</div>
      <div class="filter-group">
        <label>Zone</label>
        <select id="f-zone"><option value="">All Zones</option></select>
      </div>
      <div class="filter-group">
        <label>Party District</label>
        <select id="f-party"><option value="">All Districts</option></select>
      </div>
      <div class="filter-group">
        <label>Constituency</label>
        <select id="f-const"><option value="">All Constituencies</option></select>
      </div>
      <div class="filter-group">
        <label>Designation</label>
        <select id="f-desig"><option value="">All Designations</option></select>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Quick Filters</div>
      <div class="toggle-row" onclick="toggleFilter('active')">
        <span>Active accounts only</span>
        <div class="toggle" id="tog-active"></div>
      </div>
      <div class="toggle-row" onclick="toggleFilter('verified')">
        <span>Verified only</span>
        <div class="toggle" id="tog-verified"></div>
      </div>
      <button class="btn-reset-filters" onclick="resetFilters()">â†º Reset all filters</button>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Platform Stats</div>
    </div>
    <div class="platform-stats">
      <div class="platform-row">
        <div class="platform-dot" style="background:var(--fb)"></div>
        <span class="platform-name">Facebook</span>
        <div>
          <div class="platform-num" id="ps-fb-followers">â€”</div>
          <div class="platform-sub" id="ps-fb-active">â€”</div>
        </div>
      </div>
      <div class="platform-row">
        <div class="platform-dot" style="background:var(--tw)"></div>
        <span class="platform-name">Twitter/X</span>
        <div>
          <div class="platform-num" id="ps-tw-followers">â€”</div>
          <div class="platform-sub" id="ps-tw-active">â€”</div>
        </div>
      </div>
      <div class="platform-row">
        <div class="platform-dot" style="background:var(--ig)"></div>
        <span class="platform-name">Instagram</span>
        <div>
          <div class="platform-num" id="ps-ig-followers">â€”</div>
          <div class="platform-sub" id="ps-ig-active">â€”</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <div class="main-content">

    <!-- Toolbar -->
    <div class="grid-toolbar">
      <div class="toolbar-left">
        <span class="result-count" id="result-count">Loadingâ€¦</span>
        <button class="btn btn-ghost btn-sm" id="btn-col-toggle" onclick="toggleColumnGroup()">âŠŸ Hide Contact</button>
        <button class="btn btn-danger btn-sm" id="btn-bulk-del" style="display:none" onclick="openBulkDelete()">
          ğŸ—‘ Delete Selected (<span id="sel-count">0</span>)
        </button>
      </div>

      <!--
        FIX 2: Cursor-based pagination.
        - "First" resets cursor stack to beginning.
        - "Prev"  pops one cursor off the history stack.
        - "Next"  pushes next_cursor onto the history stack.
        - "Last page" is intentionally removed â€” not possible with keyset pagination.
        - Jump-to-page is intentionally removed â€” not possible with keyset pagination.
      -->
      <div class="pagination-controls">
        <label style="font-size:11px;color:var(--text3);font-family:var(--mono);">Rows:</label>
        <select class="page-size-select" id="page-size-sel" onchange="changePageSize(this.value)">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="200">200</option>
        </select>
        <button class="page-btn" id="btn-first" onclick="goFirst()" title="First page">Â«</button>
        <button class="page-btn" id="btn-prev"  onclick="goPrev()"  title="Previous page">â€¹</button>
        <span class="page-info" id="current-page-info">Page <strong>1</strong></span>
        <button class="page-btn" id="btn-next"  onclick="goNext()"  title="Next page">â€º</button>
      </div>
    </div>

    <div class="grid-loading-bar" id="loading-bar"></div>
    <div class="grid-wrap">
      <div id="myGrid" class="ag-theme-social" style="height:100%;width:100%"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EDIT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="edit-overlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Add Profile</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab(0)">Basic Info</button>
      <button class="modal-tab" onclick="switchTab(1)">ğŸ“˜ Facebook</button>
      <button class="modal-tab" onclick="switchTab(2)">ğŸ¦ Twitter</button>
      <button class="modal-tab" onclick="switchTab(3)">ğŸ“¸ Instagram</button>
    </div>
    <div class="modal-body">

      <!-- Tab 0: Basic -->
      <div class="tab-panel active" id="tab-0">
        <div class="form-grid">
          <div class="form-group span2">
            <label>Full Name *</label>
            <input type="text" id="f-name" placeholder="Enter full name">
          </div>
          <div class="form-group">
            <label>Designation</label>
            <input type="text" id="f-designation" placeholder="e.g. MLA, MP, President">
          </div>
          <div class="form-group">
            <label>Zone</label>
            <input type="text" id="f-zone-inp" placeholder="Zone">
          </div>
          <div class="form-group">
            <label>Party District</label>
            <input type="text" id="f-party-inp" placeholder="Party district">
          </div>
          <div class="form-group">
            <label>Constituency</label>
            <input type="text" id="f-const-inp" placeholder="Constituency">
          </div>
          <div class="form-group">
            <label>WhatsApp Number</label>
            <input type="text" id="f-whatsapp" placeholder="+91â€¦">
          </div>
          <!-- FIX 3: type="date" â€” backend now stores a real Date column -->
          <div class="form-group">
            <label>Date of Birth</label>
            <input type="date" id="f-dob">
          </div>
          <div class="form-group span2">
            <label>Email ID</label>
            <input type="email" id="f-email" placeholder="email@example.com">
          </div>
          <div class="form-group span2">
            <label>Address</label>
            <textarea id="f-address" placeholder="Full addressâ€¦"></textarea>
          </div>
        </div>
      </div>

      <!-- Tab 1: Facebook -->
      <div class="tab-panel" id="tab-1">
        <div class="platform-header">
          <div class="platform-icon fb">f</div>
          <span class="platform-label" style="color:var(--fb)">Facebook</span>
        </div>
        <div class="form-grid">
          <div class="form-group span2">
            <label>Facebook ID / URL</label>
            <input type="text" id="f-fb-id" placeholder="facebook.com/username">
          </div>
          <div class="form-group">
            <label>Followers</label>
            <input type="number" id="f-fb-followers" placeholder="0" min="0">
          </div>
          <!-- FIX 1: dropdowns now use boolean string values ("true"/"false"/"") -->
          <div class="form-group">
            <label>Active Status</label>
            <select id="f-fb-active">
              <option value="">Unknown</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Verified Status</label>
            <select id="f-fb-verified">
              <option value="">Unknown</option>
              <option value="true">Verified</option>
              <option value="false">Not Verified</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Tab 2: Twitter -->
      <div class="tab-panel" id="tab-2">
        <div class="platform-header">
          <div class="platform-icon tw">ğ•</div>
          <span class="platform-label" style="color:var(--tw)">Twitter / X</span>
        </div>
        <div class="form-grid">
          <div class="form-group span2">
            <label>Twitter Handle / ID</label>
            <input type="text" id="f-tw-id" placeholder="@username">
          </div>
          <div class="form-group">
            <label>Followers</label>
            <input type="number" id="f-tw-followers" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label>Active Status</label>
            <select id="f-tw-active">
              <option value="">Unknown</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Verified Status</label>
            <select id="f-tw-verified">
              <option value="">Unknown</option>
              <option value="true">Verified</option>
              <option value="false">Not Verified</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Tab 3: Instagram -->
      <div class="tab-panel" id="tab-3">
        <div class="platform-header">
          <div class="platform-icon ig">â—‰</div>
          <span class="platform-label" style="color:var(--ig)">Instagram</span>
        </div>
        <div class="form-grid">
          <div class="form-group span2">
            <label>Instagram ID / Handle</label>
            <input type="text" id="f-ig-id" placeholder="@handle">
          </div>
          <div class="form-group">
            <label>Followers</label>
            <input type="number" id="f-ig-followers" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label>Active Status</label>
            <select id="f-ig-active">
              <option value="">Unknown</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Verified Status</label>
            <select id="f-ig-verified">
              <option value="">Unknown</option>
              <option value="true">Verified</option>
              <option value="false">Not Verified</option>
            </select>
          </div>
        </div>
      </div>

    </div><!-- modal-body -->
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="btn-save" onclick="saveProfile()">Save Profile</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFIRM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-icon">âš ï¸</div>
    <div class="confirm-title" id="confirm-title">Confirm Delete</div>
    <div class="confirm-msg" id="confirm-msg">This action cannot be undone.</div>
    <div class="confirm-actions">
      <button class="btn btn-ghost" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-danger" id="confirm-ok">Delete</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
'use strict';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// FIX 2: cursor stack replaces offset/page-number model.
// cursors[0] is always null (beginning). cursors[n] is the next_cursor
// returned after fetching page n-1, which becomes the cursor for page n.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  editingId:     null,
  activeFilters: { active: false, verified: false },
  pageSize:      100,
  totalRows:     0,
  sortBy:        'id',
  sortOrder:     'asc',
  isLoading:     false,

  // Cursor history: index 0 = page 1 cursor (null = start)
  cursorStack:   [null],
  // Which index in the stack we're currently viewing
  pageIndex:     0,
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtNum(n) {
  if (n == null || n === '') return 'â€”';
  n = Number(n);
  if (isNaN(n)) return 'â€”';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toLocaleString();
}

function esc(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// FIX 1: helper to render boolean status as badge
function boolBadge(val, trueLabel, trueClass, falseLabel, falseClass) {
  if (val === true)  return `<span class="badge ${trueClass}">${trueLabel}</span>`;
  if (val === false) return `<span class="badge ${falseClass}">${falseLabel}</span>`;
  return `<span class="badge badge-unknown">â€”</span>`;
}

// FIX 1: convert dropdown value ("true"/"false"/"") to boolean or null for API
function parseBoolField(val) {
  if (val === 'true')  return true;
  if (val === 'false') return false;
  return null;
}

// FIX 1: convert boolean value to dropdown option string
function boolToSelectVal(val) {
  if (val === true)  return 'true';
  if (val === false) return 'false';
  return '';
}

function buildParams(extra = {}) {
  const p = new URLSearchParams();
  const s = document.getElementById('f-search').value.trim();
  if (s)  p.set('search', s);
  const z = document.getElementById('f-zone').value;
  if (z)  p.set('zone', z);
  const pd = document.getElementById('f-party').value;
  if (pd) p.set('party_district', pd);
  const c = document.getElementById('f-const').value;
  if (c)  p.set('constituency', c);
  const d = document.getElementById('f-desig').value;
  if (d)  p.set('designation', d);
  if (state.activeFilters.active)   p.set('active_only', 'true');
  if (state.activeFilters.verified) p.set('verified_only', 'true');
  p.set('sort_by', state.sortBy);
  p.set('sort_order', state.sortOrder);
  p.set('limit', state.pageSize);
  Object.entries(extra).forEach(([k, v]) => p.set(k, v));
  return p.toString();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOADING / TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(on) {
  state.isLoading = on;
  document.getElementById('loading-bar').classList.toggle('loading', on);
}

function showToast(msg, type = 'info') {
  const icons = { success: 'âœ“', error: 'âœ•', info: 'â„¹' };
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span class="toast-icon">${icons[type] || 'â„¹'}</span>
                  <span class="toast-msg">${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS (header + sidebar)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    const data = await fetch('/api/stats').then(r => r.json());
    document.getElementById('hdr-total').textContent = data.total.toLocaleString();

    const active   = (data.facebook.active || 0) + (data.twitter.active || 0) + (data.instagram.active || 0);
    const verified = (data.facebook.verified || 0) + (data.twitter.verified || 0) + (data.instagram.verified || 0);
    document.getElementById('hdr-active').textContent   = active.toLocaleString();
    document.getElementById('hdr-verified').textContent = verified.toLocaleString();

    document.getElementById('ps-fb-followers').textContent = fmtNum(data.facebook.followers);
    document.getElementById('ps-fb-active').textContent    = `${data.facebook.active} active`;
    document.getElementById('ps-tw-followers').textContent = fmtNum(data.twitter.followers);
    document.getElementById('ps-tw-active').textContent    = `${data.twitter.active} active`;
    document.getElementById('ps-ig-followers').textContent = fmtNum(data.instagram.followers);
    document.getElementById('ps-ig-active').textContent    = `${data.instagram.active} active`;
  } catch (e) {
    console.error('Stats error:', e);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILTER OPTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFilterOptions() {
  try {
    const data = await fetch('/api/filter-options').then(r => r.json());
    const fill = (id, items) => {
      const sel = document.getElementById(id);
      items.forEach(v => {
        const o = document.createElement('option');
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      });
    };
    fill('f-zone',  data.zones);
    fill('f-party', data.party_districts);
    fill('f-const', data.constituencies);
    fill('f-desig', data.designations);
  } catch (e) {
    console.error('Filter options error:', e);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AG GRID SETUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let gridApi;

// FIX 1: all status cell renderers now check boolean values
const colDefs = [
  { headerCheckboxSelection: true, checkboxSelection: true, width: 40, pinned: 'left', resizable: false, sortable: false },
  { field: 'id',          headerName: 'ID',          width: 70,  pinned: 'left', sortable: true },
  { field: 'name',        headerName: 'Name',        width: 200, pinned: 'left', sortable: true,
    cellRenderer: p => p.value ? `<span style="color:var(--text);font-family:var(--sans);font-weight:500;">${esc(p.value)}</span>` : 'â€”'
  },
  { field: 'designation', headerName: 'Designation', width: 150, sortable: true },
  { field: 'zone',        headerName: 'Zone',        width: 130, sortable: true },
  { field: 'party_district', headerName: 'District', width: 140, sortable: true },
  { field: 'constituency',   headerName: 'Constituency', width: 150, sortable: true },
  // Contact group (toggleable)
  { field: 'whatsapp_number', headerName: 'WhatsApp', width: 130, columnGroupShow: 'open' },
  { field: 'email_id',        headerName: 'Email',    width: 180, columnGroupShow: 'open' },
  // Facebook
  { field: 'facebook_id',        headerName: 'FB ID',       width: 160 },
  { field: 'facebook_followers', headerName: 'FB Followers', width: 110, sortable: true,
    cellRenderer: p => `<span class="num-cell ${(p.value||0) > 100000 ? 'num-hi' : ''}">${fmtNum(p.value)}</span>`
  },
  { field: 'facebook_active_status', headerName: 'FB Active', width: 100,
    cellRenderer: p => boolBadge(p.value, 'Active', 'badge-active', 'Inactive', 'badge-inactive')
  },
  { field: 'facebook_verified_status', headerName: 'FB Verified', width: 105,
    cellRenderer: p => boolBadge(p.value, 'Verified', 'badge-verified', 'Not Verified', 'badge-unverified')
  },
  // Twitter
  { field: 'twitter_id',        headerName: 'TW ID',       width: 140 },
  { field: 'twitter_followers', headerName: 'TW Followers', width: 110, sortable: true,
    cellRenderer: p => `<span class="num-cell ${(p.value||0) > 100000 ? 'num-hi' : ''}">${fmtNum(p.value)}</span>`
  },
  { field: 'twitter_active_status', headerName: 'TW Active', width: 100,
    cellRenderer: p => boolBadge(p.value, 'Active', 'badge-active', 'Inactive', 'badge-inactive')
  },
  { field: 'twitter_verified_status', headerName: 'TW Verified', width: 105,
    cellRenderer: p => boolBadge(p.value, 'Verified', 'badge-verified', 'Not Verified', 'badge-unverified')
  },
  // Instagram
  { field: 'instagram_id',        headerName: 'IG ID',       width: 140 },
  { field: 'instagram_followers', headerName: 'IG Followers', width: 110, sortable: true,
    cellRenderer: p => `<span class="num-cell ${(p.value||0) > 100000 ? 'num-hi' : ''}">${fmtNum(p.value)}</span>`
  },
  { field: 'instagram_active_status', headerName: 'IG Active', width: 100,
    cellRenderer: p => boolBadge(p.value, 'Active', 'badge-active', 'Inactive', 'badge-inactive')
  },
  { field: 'instagram_verified_status', headerName: 'IG Verified', width: 105,
    cellRenderer: p => boolBadge(p.value, 'Verified', 'badge-verified', 'Not Verified', 'badge-unverified')
  },
  // Actions
  { headerName: 'Actions', width: 110, pinned: 'right', sortable: false, resizable: false,
    cellRenderer: p => `
      <div class="action-cell">
        <button class="act-btn act-edit" onclick="openEdit(${p.data.id})">Edit</button>
        <button class="act-btn act-del"  onclick="confirmDelete(${p.data.id}, '${esc(p.data.name || '')}')">Del</button>
      </div>`
  },
];

function initGrid() {
  gridApi = agGrid.createGrid(document.getElementById('myGrid'), {
    columnDefs: colDefs,
    rowData: [],
    rowSelection: 'multiple',
    suppressRowClickSelection: true,
    suppressMovableColumns: false,
    defaultColDef: {
      resizable: true,
      sortable:  false,
      suppressMenu: true,
    },
    onSelectionChanged: () => {
      const n = gridApi.getSelectedRows().length;
      document.getElementById('btn-bulk-del').style.display = n > 0 ? '' : 'none';
      document.getElementById('sel-count').textContent = n;
    },
    onSortChanged: e => {
      const col = e.api.getColumnState().find(c => c.sort);
      if (col) {
        state.sortBy    = col.colId;
        state.sortOrder = col.sort;
      } else {
        state.sortBy    = 'id';
        state.sortOrder = 'asc';
      }
      resetAndLoad();
    },
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX 2: CURSOR PAGINATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Wipe cursor history and start from the beginning
function resetAndLoad() {
  state.cursorStack = [null];
  state.pageIndex   = 0;
  loadPage();
}

async function loadPage() {
  if (state.isLoading) return;
  setLoading(true);

  // Current cursor is whatever is at our position in the stack
  const cursor = state.cursorStack[state.pageIndex];
  const extra  = { limit: state.pageSize };
  if (cursor) extra.cursor = cursor;

  try {
    const qs   = buildParams(extra);
    const data = await fetch(`/api/profiles?${qs}`).then(r => r.json());

    gridApi.setGridOption('rowData', data.rows);
    state.totalRows = data.total;

    // Store next_cursor at pageIndex+1 if we got one
    if (data.next_cursor) {
      state.cursorStack[state.pageIndex + 1] = data.next_cursor;
    } else {
      // Trim any stale cursors beyond this point
      state.cursorStack = state.cursorStack.slice(0, state.pageIndex + 1);
    }

    updatePaginationUI(data.next_cursor);
    updateResultCount(data.rows.length, data.total);
  } catch (e) {
    showToast('Failed to load profiles', 'error');
    console.error(e);
  } finally {
    setLoading(false);
  }
}

function updatePaginationUI(hasNextCursor) {
  const pageNum = state.pageIndex + 1;
  document.getElementById('current-page-info').innerHTML =
    `Page <strong>${pageNum}</strong> Â· <span style="color:var(--text3)">${state.totalRows.toLocaleString()} total</span>`;

  document.getElementById('btn-first').disabled = state.pageIndex === 0;
  document.getElementById('btn-prev').disabled  = state.pageIndex === 0;
  document.getElementById('btn-next').disabled  = !hasNextCursor && !state.cursorStack[state.pageIndex + 1];
}

function updateResultCount(shown, total) {
  const start = state.pageIndex * state.pageSize + 1;
  const end   = start + shown - 1;
  document.getElementById('result-count').textContent =
    `Showing ${start.toLocaleString()}â€“${end.toLocaleString()} of ${total.toLocaleString()} rows`;
}

function goFirst() {
  state.pageIndex = 0;
  loadPage();
}

function goPrev() {
  if (state.pageIndex > 0) {
    state.pageIndex--;
    loadPage();
  }
}

function goNext() {
  if (state.cursorStack[state.pageIndex + 1] !== undefined) {
    state.pageIndex++;
    loadPage();
  }
}

function changePageSize(val) {
  state.pageSize = parseInt(val);
  resetAndLoad();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COLUMN TOGGLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let contactHidden = false;
function toggleColumnGroup() {
  contactHidden = !contactHidden;
  gridApi.setColumnsVisible(['whatsapp_number', 'email_id'], !contactHidden);
  document.getElementById('btn-col-toggle').textContent =
    contactHidden ? 'âŠ Show Contact' : 'âŠŸ Hide Contact';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILTERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let searchDebounce;
function setupFilterListeners() {
  document.getElementById('f-search').addEventListener('input', () => {
    clearTimeout(searchDebounce);
    searchDebounce = setTimeout(resetAndLoad, 350);
  });
  ['f-zone','f-party','f-const','f-desig'].forEach(id => {
    document.getElementById(id).addEventListener('change', resetAndLoad);
  });
}

function toggleFilter(key) {
  state.activeFilters[key] = !state.activeFilters[key];
  document.getElementById(`tog-${key}`).classList.toggle('on', state.activeFilters[key]);
  resetAndLoad();
}

function resetFilters() {
  document.getElementById('f-search').value = '';
  document.getElementById('f-zone').value   = '';
  document.getElementById('f-party').value  = '';
  document.getElementById('f-const').value  = '';
  document.getElementById('f-desig').value  = '';
  state.activeFilters.active   = false;
  state.activeFilters.verified = false;
  document.getElementById('tog-active').classList.remove('on');
  document.getElementById('tog-verified').classList.remove('on');
  resetAndLoad();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MODAL â€” FIX 1 + FIX 3 applied
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(n) {
  document.querySelectorAll('.tab-panel').forEach((p, i) => p.classList.toggle('active', i === n));
  document.querySelectorAll('.modal-tab').forEach((t, i) => t.classList.toggle('active', i === n));
}

function openAdd() {
  state.editingId = null;
  document.getElementById('modal-title').textContent = 'Add Profile';
  clearForm();
  switchTab(0);
  document.getElementById('edit-overlay').classList.add('open');
}

function openEdit(id) {
  state.editingId = id;
  document.getElementById('modal-title').textContent = 'Edit Profile';
  fetch(`/api/profiles/${id}`)
    .then(r => r.json())
    .then(p => {
      document.getElementById('f-name').value        = p.name         || '';
      document.getElementById('f-designation').value = p.designation  || '';
      document.getElementById('f-zone-inp').value    = p.zone         || '';
      document.getElementById('f-party-inp').value   = p.party_district || '';
      document.getElementById('f-const-inp').value   = p.constituency || '';
      document.getElementById('f-whatsapp').value    = p.whatsapp_number || '';
      // FIX 3: dob is now an ISO date string (YYYY-MM-DD) â€” date input handles it natively
      document.getElementById('f-dob').value         = p.dob          || '';
      document.getElementById('f-email').value       = p.email_id     || '';
      document.getElementById('f-address').value     = p.address      || '';
      document.getElementById('f-fb-id').value       = p.facebook_id  || '';
      document.getElementById('f-fb-followers').value = p.facebook_followers ?? '';
      // FIX 1: convert boolean from API to select value
      document.getElementById('f-fb-active').value   = boolToSelectVal(p.facebook_active_status);
      document.getElementById('f-fb-verified').value = boolToSelectVal(p.facebook_verified_status);
      document.getElementById('f-tw-id').value       = p.twitter_id   || '';
      document.getElementById('f-tw-followers').value = p.twitter_followers ?? '';
      document.getElementById('f-tw-active').value   = boolToSelectVal(p.twitter_active_status);
      document.getElementById('f-tw-verified').value = boolToSelectVal(p.twitter_verified_status);
      document.getElementById('f-ig-id').value       = p.instagram_id || '';
      document.getElementById('f-ig-followers').value = p.instagram_followers ?? '';
      document.getElementById('f-ig-active').value   = boolToSelectVal(p.instagram_active_status);
      document.getElementById('f-ig-verified').value = boolToSelectVal(p.instagram_verified_status);
    })
    .catch(() => showToast('Failed to load profile', 'error'));
  switchTab(0);
  document.getElementById('edit-overlay').classList.add('open');
}

function clearForm() {
  ['f-name','f-designation','f-zone-inp','f-party-inp','f-const-inp',
   'f-whatsapp','f-dob','f-email','f-address',
   'f-fb-id','f-fb-followers','f-tw-id','f-tw-followers','f-ig-id','f-ig-followers']
    .forEach(id => { document.getElementById(id).value = ''; });
  ['f-fb-active','f-fb-verified','f-tw-active','f-tw-verified','f-ig-active','f-ig-verified']
    .forEach(id => { document.getElementById(id).value = ''; });
}

function closeModal() {
  document.getElementById('edit-overlay').classList.remove('open');
}

async function saveProfile() {
  const name = document.getElementById('f-name').value.trim();
  if (!name) { showToast('Name is required', 'error'); return; }

  // FIX 1: parse all boolean fields before sending to API
  const body = {
    name,
    designation:    document.getElementById('f-designation').value.trim() || null,
    zone:           document.getElementById('f-zone-inp').value.trim()    || null,
    party_district: document.getElementById('f-party-inp').value.trim()   || null,
    constituency:   document.getElementById('f-const-inp').value.trim()   || null,
    whatsapp_number: document.getElementById('f-whatsapp').value.trim()   || null,
    // FIX 3: dob is already ISO format from date input
    dob:            document.getElementById('f-dob').value || null,
    email_id:       document.getElementById('f-email').value.trim()       || null,
    address:        document.getElementById('f-address').value.trim()     || null,

    facebook_id:               document.getElementById('f-fb-id').value.trim()       || null,
    facebook_followers:        document.getElementById('f-fb-followers').value !== '' ? parseInt(document.getElementById('f-fb-followers').value) : null,
    facebook_active_status:    parseBoolField(document.getElementById('f-fb-active').value),
    facebook_verified_status:  parseBoolField(document.getElementById('f-fb-verified').value),

    twitter_id:                document.getElementById('f-tw-id').value.trim()        || null,
    twitter_followers:         document.getElementById('f-tw-followers').value !== '' ? parseInt(document.getElementById('f-tw-followers').value) : null,
    twitter_active_status:     parseBoolField(document.getElementById('f-tw-active').value),
    twitter_verified_status:   parseBoolField(document.getElementById('f-tw-verified').value),

    instagram_id:              document.getElementById('f-ig-id').value.trim()        || null,
    instagram_followers:       document.getElementById('f-ig-followers').value !== '' ? parseInt(document.getElementById('f-ig-followers').value) : null,
    instagram_active_status:   parseBoolField(document.getElementById('f-ig-active').value),
    instagram_verified_status: parseBoolField(document.getElementById('f-ig-verified').value),
  };

  const url    = state.editingId ? `/api/profiles/${state.editingId}` : '/api/profiles';
  const method = state.editingId ? 'PUT' : 'POST';

  try {
    document.getElementById('btn-save').disabled = true;
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || `HTTP ${res.status}`);
    }
    closeModal();
    showToast(state.editingId ? 'Profile updated' : 'Profile created', 'success');
    resetAndLoad();
    loadStats();
  } catch (e) {
    showToast(`Save failed: ${e.message}`, 'error');
  } finally {
    document.getElementById('btn-save').disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DELETE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingDeleteId = null;

function confirmDelete(id, name) {
  pendingDeleteId = id;
  document.getElementById('confirm-title').textContent = 'Delete Profile?';
  document.getElementById('confirm-msg').textContent   =
    `"${name || 'This profile'}" will be permanently deleted.`;
  document.getElementById('confirm-ok').onclick = executeDelete;
  document.getElementById('confirm-overlay').classList.add('open');
}

function closeConfirm() {
  pendingDeleteId = null;
  document.getElementById('confirm-overlay').classList.remove('open');
}

async function executeDelete() {
  if (!pendingDeleteId) return;
  closeConfirm();
  try {
    await fetch(`/api/profiles/${pendingDeleteId}`, { method: 'DELETE' });
    showToast('Profile deleted', 'success');
    resetAndLoad();
    loadStats();
  } catch (e) {
    showToast('Delete failed', 'error');
  }
}

function openBulkDelete() {
  const rows = gridApi.getSelectedRows();
  if (!rows.length) return;
  document.getElementById('confirm-title').textContent = `Delete ${rows.length} profiles?`;
  document.getElementById('confirm-msg').textContent   = 'This cannot be undone.';
  document.getElementById('confirm-ok').onclick = async () => {
    closeConfirm();
    try {
      await fetch('/api/profiles/bulk-delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: rows.map(r => r.id) }),
      });
      showToast(`Deleted ${rows.length} profiles`, 'success');
      resetAndLoad();
      loadStats();
    } catch (e) {
      showToast('Bulk delete failed', 'error');
    }
  };
  document.getElementById('confirm-overlay').classList.add('open');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CSV EXPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-export').addEventListener('click', () => {
  const qs = buildParams();
  window.location.href = `/api/export/csv?${qs}`;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WIRE UP BUTTONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-add').addEventListener('click', openAdd);

// ESC closes modals
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeConfirm(); }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  initGrid();
  setupFilterListeners();
  await Promise.all([loadFilterOptions(), loadStats()]);
  resetAndLoad();
})();
</script>
</body>
</html>
